---
// src/components/Giscus.astro
---

<div class="giscus-container">
  <script 
    src="https://giscus.app/client.js"
    data-repo="hqslsz/fuwari"
    data-repo-id="R_kgDOP7oSqQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOP7oSqc4CwRKO"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="transparent_light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
</div>

<script>
  // 确保只运行一次
  let isInitialized = false;

  function initGiscusTheme() {
    if (isInitialized) return;
    isInitialized = true;

    const checkIframe = setInterval(() => {
      const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
      if (iframe) {
        clearInterval(checkIframe);
        // 等待 iframe 完全加载
        setTimeout(() => {
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
              {
                giscus: {
                  setConfig: {
                    theme: 'transparent_light'
                  }
                }
              },
              'https://giscus.app'
            );
          }
        }, 500);
      }
    }, 100);

    // 10秒后停止检查
    setTimeout(() => clearInterval(checkIframe), 10000);
  }

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusTheme);
  } else {
    initGiscusTheme();
  }

  // 监听系统主题变化，确保始终使用透明浅色主题
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  const handleThemeChange = () => {
    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(
        {
          giscus: {
            setConfig: {
              theme: 'transparent_light'
            }
          }
        },
        'https://giscus.app'
      );
    }
  };

  // 监听系统主题变化
  mediaQuery.addEventListener('change', handleThemeChange);
</script>

<style>
  .giscus-container {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--line-divider, #e5e7eb);
    /* 使用透明背景，让背景图可见 */
    background-color: transparent;
  }

  /* 确保 giscus iframe 也是透明的 */
  .giscus-container :global(iframe.giscus-frame) {
    background: transparent !important;
  }
</style>